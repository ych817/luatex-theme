% \setmonofont{JuliaMono-Medium}
\setmonofont[                                                % 设置代码块字体
  Contextuals={Alternate}
]{Fira Code}
\usemintedstyle{material}                                    % 代码块主体高亮风格(见https://pygments.org/styles/)
\colorlet{colorCodefenceBodyDraw}{Gray}                      % 代码块主体边框颜色
\colorlet{colorCodefenceBodyFill}{Black!80!DarkBlue}         % 代码块主体填充颜色
\colorlet{colorCodefenceBodyFillHL}{Black!60!Periwinkle}     % 代码块主体填充颜色-高亮行

\colorlet{colorCodeinlineBodyDraw}{Gray}                     % 行内代码块边框颜色
\colorlet{colorCodeinlineBodyFill}{Black!80!DarkBlue}        % 行内代码块填充颜色
\colorlet{colorCodeinlineBodyFillHL}{black!60!Periwinkle}    % 行内代码块填充颜色-高亮行

\colorlet{colorCodefenceNmbrText}{white!25!LightSteelBlue}   % 代码块行号文字颜色
\colorlet{colorCodefenceNmbrFill}{colorCodefenceBodyFill}    % 代码块行号填充颜色

\colorlet{colorCodefenceTitlText}{colorCodefenceNmbrText}    % 代码块标题文字颜色
\colorlet{colorCodefenceTitlDraw}{colorCodefenceNmbrText}    % 代码块标题边框颜色
\colorlet{colorCodefenceTitlFill}{colorCodefenceBodyFill}    % 代码块标题边框颜色

\tikzset{ % 用于下面 tcblisting 的 finish 键
  codeforce/header/.style={
    line width=.4pt,
    font=\ttfamily\relscale{.7},
    text=colorCodefenceTitlText,
    text opacity=1,
    text height=0.7*height("/()Fg泥濠"),
    text depth =0.7* depth("/()Fg泥濠"),
    outer xsep=0pt,
    outer ysep=0pt,
    inner ysep=1pt
  }
}
\tcbset{
  codestyle/.style={
    fontupper=\relscale{.7},
    breakable,
    enhanced,
    skin first=enhanced,
    skin middle=enhanced,
    skin last=enhanced,
    % bicolor, % 会导致 enhanced 的功能失效 这是另一种 skin
    colframe=colorCodefenceBodyDraw,
    colback=colorCodefenceBodyFill,
    colbacklower=LightGray!50,
    boxrule=.4pt,
    arc=5pt,
    top=2.5mm,
    bottom=2mm,
    center lower,
  }
}
\setminted{
  breaklines=true,
  breakanywhere=true,
  escapeinside= 脎吡,%
  encoding=utf8,
  tabsize=2,
}

% 使黑暗模式下所有代码都能可见 。代码来自 https://tex.stackexchange.com/a/742098/242598
\renewcommand\FancyVerbFormatText[1]{\textcolor{colorCodefenceNmbrText}{#1}}
\fvset{breaksymbolleft=\textcolor{colorCodefenceNmbrText}{\tiny\ensuremath{\hookrightarrow}}}
% 代码块中高亮行的行号也能被高亮 。代码来自 https://tex.stackexchange.com/a/741983/242598
% 相关的库 : minted , fbextra , fancyvrb , etoolbox
\input{layouts_origin/set_code_fvextra01}
% 代码块外观样式设置
% 相关的库 : minted , tcolorbox , xparse

\NewTCBListing{codefence}{ !E{\FileName\Syntax\Lexer\Highlight\Mode}{{}{latex}{#2}{}{listing only}} }{%
  code={\linespread{1.3}},
  codestyle,
  boxsep=2pt,
  right=-2pt, % 对应 boxsep
  % 代码块中标题和语法名称可以显示在 tcb 的上层 。代码来自 https://tex.stackexchange.com/a/742065/242598
  finish={
    \node(syntax) [anchor=north east, codeforce/header]
      at ([xshift=-5pt]interior.north east) {#2};
    \IfValueT{#1}{
    \begin{tcbclipframe}
    \node(header) [anchor=north west, codeforce/header]
      at ([xshift=+5pt]interior.north west) {#1};
    \end{tcbclipframe}
    }
  },
  #5, % 默认 listing only , 可以换成 listing and comment 及其他
  listing engine=minted,
  minted language = #3, 
  minted options = {   % minted 设置
    tabsize=2,
    linenos=true,
    numbersep=5pt,
    highlightlines={#4},
    highlightcolor=colorCodefenceBodyFillHL,
    xleftmargin=+10pt,
  }
}
% 行内代码块外观设置
% 相关的库 : tcolorbox
\newtcbox{\codeinlineTCB}{% 行间代码块设置
  codestyle,
  colupper=colorCodefenceNmbrText,
  nobeforeafter,
  boxsep=1.5pt,
  left=2pt,
  right=2pt,
  top=0pt,
  bottom=0pt,
  on line, % 位置设置
}
\newcommand{\codeinline}[2][latex]{%
  \vphantom{\scriptsize\ttfamily (Fg泥濠)}%
  \codeinlineTCB{\vphantom{\tt (Fg泥濠)}\mintinline{#1}{#2}}%
}
% 代码块中高亮一行内的部分内容 。
% 相关的库 : 
\newcommand{\codeHL}[2][colorCodefenceBodyFillHL]{%        % 代码高亮部分
    \setlength\fboxsep{0pt}%
    \rlap{\colorbox{#1}{\vphantom{(Fg)}\phantom{#2}}}%
    \setlength\fboxsep{3pt}%
}%